# shellcheck shell=bash

# author:       Li Junhao           edwin.jh.lee@gmail.com    edwinjhlee.github.io
# maintainer:   Li Junhao      

# TODO: we should only check status
test.run.all() {
    local i
    for i in $(typeset -F | cut -d ' ' -f 3 | grep "tc:" | grep -v "tc:setup" | grep -v "tc:teardown"); do
        tc:setup
        @catch-final "
            Test Fail: codeline \$LINENO
        " "
            echo 'final'
            # aaa # Wrong command
        "
        eval "$i"
        tc:teardown
    done
}

tc.info(){
    echo hi
}


# TODO: We have to honor the TAP protocol
# TODO: Please follow http://testanything.org/tap-specification.html

test.tap(){
    # Version
    echo "TAP version 13" >&3

    # The Plan
    echo "1..${NUMBER_OF_TESTCASE}"

    # Test Line
    echo "ok $INDEX $DESCRIPTION"

    echo "not ok $INDEX $DESCRIPTION"
}

testsuite(){
    local filepath func
    for filepath in "$@"; do
        if (
            for func in $(typeset -F | cut -d ' ' -f 3 | grep "tc:" ); do
                unset -f "$func" 
            done >&2
            # shellcheck disable=SC1090
            source "$filepath" >&2
            ( test.run.all ) >&2
            echo "$?"
        ); then
            :
        else
            echo "Fail on test file: $filepath"
            return 1
        fi

    done
}


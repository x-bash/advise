# shellcheck shell=bash

# author:       Li Junhao           edwin.jh.lee@gmail.com    edwinjhlee.github.io
# maintainer:   Li Junhao

dict_make(){
    local O="${1:?list_name}"
    eval "$O=0"
}

# O=b dload "$( a.dump | dgrep "abc" | dgerp "abc" )"

dict_dump(){
    local O="${O:?list_name}"
    local data
    eval printf "%s" "\"\$${O}\""
}

dict_load(){
    local O="${O:?list_name}"
    local s
    s="$(cat)"
    eval "$O"='"$s"'
}

: <<'DOCTEST'
> dict_make b
> O=b dict_put 1 a
> O=b dict_put 2 b
> O=b dict_put 3 c
> O=b dict_has 2 && echo yes
yes
> O=b dict_has 4 && echo yes
DOCTEST
dict_has(){
    dict_get "$@" > /dev/null
}

: <<'DOCTEST'
> dict_make b
> O=b dict_put 1 a
> O=b dict_put 2 b
> O=b dict_put 3 c
> O=b dict_size
3
DOCTEST
dict_size(){
    local data
    data="$(eval printf "%s" "\"\$${O:?list_name}\"")"

    local len
    len="${data##*${DICT_SEP}}"

    printf "%s" "${len:-0}"
}

: <<'DOCTEST'
> dict_make b
> O=b dict_isempty && echo yes
yes
> O=b dict_put 1 a
> O=b dict_isempty && echo yes
DOCTEST
dict_isempty(){
    [ "$(dict_size)" -eq 0 ]
}

: <<'DOCTEST'
> dict_make b
> O=b dict_put 1 a
> O=b dict_put 2 b
> O=b dict_put 3 c
> O=b dict_get 2
b
DOCTEST
dict_get(){
    if [ -z "$O" ]; then
        dict_pget "$@"
        return
    fi
    eval printf "%s" "\"\$${O}\"" | dict_pget "$@"
}

dict_put(){
    if [ -z "$O" ]; then
        dict_pput "$@"
        return
    fi

    local s
    s="$(eval printf "%s" "\"\$${O}\"" | dict_pput "$@")"

    eval "$O=\"\$s\""
}

: <<'DOCTEST'
> dict_make b
> O=b dict_put el user edwinjhlee
> O=b dict_put lt user lteam
> O=b dict_put el password goforit
> O=b dict_put lt password 2008
> O=b dict_scope el | dict_print
user=edwinjhlee
password=goforit
> O=b dict_scope lt | dict_json
{
  "user": "lteam",
  "password": "2008"
}
DOCTEST
dict_scope(){
    if [ -z "$O" ]; then
        dict_pscope "$@"
        return
    fi

    eval printf "%s" "\"\$${O}\"" | dict_pscope "$@"
}

: <<'DOCTEST'
> dict_make b
> O=b dict_put 1 a
> O=b dict_put 2 b
> O=b dict_put 3 c
> O=b dict_drop 4 && echo yes
> O=b dict_has 2 && echo yes
yes
> O=b dict_drop 2 && echo yes
yes
> O=b dict_has 2 && echo yes
DOCTEST
dict_drop(){
    if [ -z "$O" ]; then
        dict_pdrop "$@"
        return
    fi
    
    local O="${O:?list_name}"
    local s
    if s="$(eval printf "%s" "\"\$${O}\"" | dict_pdrop "$@")"; then
        eval "$O=\"\$s\""
    else
        return 1
    fi    
}

: <<'DOCTEST'
> dict_make b
> O=b dict_put 1 a
> O=b dict_put 2 b
> O=b dict_put 3 c
> O=b dict_dropr "[1-3]+" && echo yes
yes
> O=b dict_has 1 && echo yes
> O=b dict_has 3 && echo yes
DOCTEST
dict_dropr(){
    if [ -z "$O" ]; then
        dict_pdropr "$@"
        return
    fi

    local O="${O:?list_name}"
    local s
    if s="$(eval printf "%s" "\"\$${O}\"" | dict_pdropr "$@")"; then
        eval "$O=\"\$s\""
    else
        return 1
    fi
}


dict_grep(){
    if [ -z "$O" ]; then
        dict_pgrep "$@"
        return
    fi
    
    local O="${O:?list_name}"
    local s
    if s="$(eval printf "%s" "\"\$${O}\"" | dict_pgrep "$@" -)"; then
        eval "$O=\"\$s\""
    else
        return 1
    fi    
}

dict_pgrepr(){
    if [ -z "$O" ]; then
        dict_pgrepr "$@"
        return
    fi

    local O="${O:?list_name}"
    local s
    if s="$(eval printf "%s" "\"\$${O}\"" | dict_pgrepr "$@" -)"; then
        eval "$O=\"\$s\""
    else
        return 1
    fi
}

dict_json(){
    if [ -z "$O" ]; then
        dict_pjson "$@"
        return
    fi
    eval printf "%s" "\"\$${O}\"" | dict_pjson "$@"
}

dict_print(){
    if [ -z "$O" ]; then
        dict_pprint "$@"
        return
    fi
    eval printf "%s" "\"\$${O}\"" | dict_pprint "$@"
}

